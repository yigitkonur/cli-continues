name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22, 24]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: pnpm test

  test-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - run: pnpm install --frozen-lockfile

      - name: Run tests and check quality
        run: |
          # Run tests with JSON reporter
          npx vitest run --reporter=json --outputFile=test-results.json 2>/dev/null || true

          # Count tests from JSON output
          TOTAL_TESTS=$(node -e "try{const r=JSON.parse(require('fs').readFileSync('test-results.json','utf8'));console.log(r.numTotalTests||0)}catch{console.log(0)}")
          PASSED=$(node -e "try{const r=JSON.parse(require('fs').readFileSync('test-results.json','utf8'));console.log(r.numPassedTests||0)}catch{console.log(0)}")
          FAILED=$(node -e "try{const r=JSON.parse(require('fs').readFileSync('test-results.json','utf8'));console.log(r.numFailedTests||0)}catch{console.log(0)}")
          TEST_FILES=$(node -e "try{const r=JSON.parse(require('fs').readFileSync('test-results.json','utf8'));console.log(r.numTotalTestSuites||0)}catch{console.log(0)}")

          # Check for source vs test file changes
          CHANGED_SRC=$(git diff --name-only origin/main...HEAD -- 'src/**/*.ts' ':!src/__tests__/**' | wc -l | tr -d ' ')
          CHANGED_TESTS=$(git diff --name-only origin/main...HEAD -- 'src/__tests__/**' | wc -l | tr -d ' ')

          # Build summary
          cat > test-summary.md << 'HEADER'
          ## Test Quality Report
          HEADER

          echo "" >> test-summary.md
          echo "| Metric | Value |" >> test-summary.md
          echo "|--------|-------|" >> test-summary.md
          echo "| Total tests | $TOTAL_TESTS |" >> test-summary.md
          echo "| Passed | $PASSED |" >> test-summary.md
          echo "| Failed | $FAILED |" >> test-summary.md
          echo "| Test files | $TEST_FILES |" >> test-summary.md
          echo "| Source files changed | $CHANGED_SRC |" >> test-summary.md
          echo "| Test files changed | $CHANGED_TESTS |" >> test-summary.md
          echo "" >> test-summary.md

          if [ "$FAILED" -gt 0 ]; then
            echo "> **Tests are failing.** Fix failing tests before merging." >> test-summary.md
          elif [ "$CHANGED_SRC" -gt 0 ] && [ "$CHANGED_TESTS" -eq 0 ]; then
            echo "> **No test changes detected.** Consider adding tests for the $CHANGED_SRC changed source file(s)." >> test-summary.md
          else
            echo "> Tests look good." >> test-summary.md
          fi

          cat test-summary.md

          # Fail only if tests actually fail
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Comment on PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: test-summary.md
